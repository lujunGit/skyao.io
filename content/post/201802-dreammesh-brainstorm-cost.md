+++
title = "DreamMesh抛砖引玉(6)-性能"

date = 2018-02-21
lastmod = 2018-02-21
draft = true

tags = ["DreamMesh"]
summary = "Service Mesh会带来哪些额外的资源消耗？对性能会有什么样的影响？哪些情况下会导致不适用？"
abstract = "Service Mesh会带来哪些额外的资源消耗？对性能会有什么样的影响？哪些情况下会导致不适用？"

[header]
image = "headers/dreammesh-brainstorm-6.jpg"
caption = ""

+++

## 序列化性能

![](images/conmunicate.png)

从图中可以看到，虽然加入Mesh（有可能是两个，如Istio/Conduit都是客户端服务器各一个），但是在Mesh内只读取（也可能做一些必要的修改）header，没有对Payload进行处理。

因此，全程下来，和侵入式开发框架相比，以HTTP协议为例，对比如下：


| 模式 | Payload序列化 | Payload反序列化 | HTTP协议解析 | HTTP协议组装 |
|--------|--------|--------|--------|--------|
|   侵入式开发框架     |    1次    |    1次    | 1次 | 1次 |
|   Service Mesh     |    1次   |    1次    | 3次 | 3次 |

因此，全程下来，和侵入式开发框架相比：

1. 在Payload序列化方面的开销基本相当

	都只是一次序列化和反序列化，而且都没有发生在Mesh内部。因此引入Service Mesh之后，完全不必担心Payload序列化和反序列化的性能。原来是什么性能现在还是如此，不增不减。

2. 多了两次HTTP协议的解析和组装

	假定HTTP协议处理的资源消耗为1，我们来看当Payload不同时的性能对比：

	| 消耗 | Payload很重 | Payload稍重 | Payload很轻 | Payload为空 |
    |--------|--------|--------|--------|--------|
    |   Payload序列化     |    10000    |    100    | 10 | 0 |
	|   侵入式开发框架协议处理     |    2    |    2    | 2 | 2 |
    |   Service Mesh协议处理     |    6    |    6    | 6 | 6 |
	|   侵入式开发框架总额     |    10002    |    102    | 12 | 2 |
    |   Service Mesh总额     |    10006    |    106    | 16 | 6 |
	|   消耗对比     |    增加4/10000    |    增加4%    | 增加33% | 增加200% |

	结论就是：payload越重，Service Mesh增加的消耗就越不起眼。但是对于Payload很轻的情况，尤其对于HTTP GET这种没有payload的请求，Service Mesh消耗增加的就会变的很夸张：增加200%！

3. 考虑服务器端处理请求的消耗大小

	| 消耗 | 消耗很大的请求 | 一般请求 | 请求很轻 | 空请求 |
    |--------|--------|--------|--------|--------|
    |   服务器端处理请求的消耗     |    1000000    |    10000    | 100 | 0 |
	|   侵入式开发框架     |    10002    |    102    | 12 | 2 |
    |   Service Mesh     |    10006    |    106    | 16 | 6 |
    |   侵入式开发框架总额     |    1010002    |    10102    | 112 | 2 |
    |   Service Mesh总额     |    1010006    |    10106    | 116 | 6 |
	|   消耗对比     |    增加少到可忽略    |    增加4/10000    | 增加3% | 增加200% |

结论：

1. 对于普通请求，有payload而且服务器端需要处理时，多增加的4次HTTP协议处理带来的消耗不大，大部分情况下几乎可以忽略。
2. 对于特别轻量级的请求，比如没有payload而且服务器端处理简单（不做请求，或者足够简单如命中缓存）而且应答简单，则多增加的4次HTTP协议处理会带来非常明显的性能损失

	> TBD： 此处有待实际验证，需要跑压力测试进行对比。

## 远程调用

![](images/remotecall.png)

## 总结


